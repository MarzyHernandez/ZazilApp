<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Meta -->
    <meta name="description" content="Responsive Bootstrap Admin Dashboards">
    <meta name="author" content="Bootstrap Gallery" />
    <link rel="canonical" href="https://www.bootstrap.gallery/">
    <meta property="og:url" content="https://www.bootstrap.gallery">
    <meta property="og:title" content="Admin Templates - Dashboard Templates | Bootstrap Gallery">
    <meta property="og:description" content="Marketplace for Bootstrap Admin Dashboards">
    <meta property="og:type" content="Website">
    <meta property="og:site_name" content="Bootstrap Gallery">
    <link rel="shortcut icon" href="assets/images/logo_zazil.png">

    <!-- Title -->
    <title>Zazil Productos</title>

    <!-- Common Css Files -->
    <link rel="stylesheet" href="assets/css/animate.css">
    <link rel="stylesheet" href="assets/fonts/bootstrap/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/main.min.css">

    <!-- Vendor Css Files -->
    <link rel="stylesheet" href="assets/vendor/overlay-scroll/OverlayScrollbars.min.css">
</head>

<body>

    <!-- Page wrapper start -->
    <div class="page-wrapper">

        <!-- Sidebar wrapper start -->
        <nav class="sidebar-wrapper">
            <!-- Sidebar brand starts -->
            <div class="sidebar-brand">
                <a href="index.html" class="logo">
                    <img src="assets/images/logo_zazil.png"/>
                </a>
            </div>
            <!-- Sidebar brand starts -->

            <!-- Sidebar menu starts -->
            <div class="sidebar-menu">
                <div class="sidebarMenuScroll">
                    <ul>
                        <li class="sidebar-dropdown">
                            <a href="index.html">
                                <i class="bi bi-house"></i>
                                <span class="menu-text">Dashboard</span>
                            </a>
                        </li>
                        <li class="sidebar-dropdown active">
                            <a href="#">
                                <i class="bi bi-handbag"></i>
                                <span class="menu-text">Ventas</span>
                            </a>
                            <div class="sidebar-submenu">
                                <ul>
                                    <li>
                                        <a href="orders.html">Historial Compras</a>
                                    </li>
                                    <li>
                                        <a href="products.html" class="current-page">Productos</a>
                                    </li>
                                    <li>
                                        <a href="add-product.html">Añadir Productos</a>
                                    </li>
                                    <li>
                                        <a href="add-post.html">Añadir Publicación</a>
                                    </li>
                                    <li>
                                        <a href="add-faq.html">Añadir Pregunta <br> <center>Frecuente</center></a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li class="sidebar">
                            <a href="calendar-google.html">
                                <i class="bi bi-calendar4"></i>
                                <span class="menu-text">Calendarios</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- Sidebar menu ends -->
        </nav>
        <!-- Sidebar wrapper end -->

        <!-- Main container start -->
        <div class="main-container">
            

            <!-- Page header starts -->
            <div class="page-header">
                <div class="toggle-sidebar" id="toggle-sidebar"><i class="bi bi-list"></i></div>

                <!-- Breadcrumb start -->
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><i class="bi bi-house"></i></li>
                    <li class="breadcrumb-item breadcrumb-active" aria-current="page">Productos</li>
                </ol>
                <!-- Breadcrumb end -->
            </div>
            <!-- Page header ends -->

            <!-- Content wrapper scroll start -->
            <div class="content-wrapper-scroll">

                <!-- Content wrapper start -->
                <div class="content-wrapper">

                    <!-- Row start -->
                    <div class="row gx-3">
                        <div class="col-sm-12 col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Lista de productos</div>
                                </div>
                                <div class="card-body">

                                    <!-- Row start -->
                                    <div class="row gx-3" id="product-list">
                                        <!-- Aquí se insertarán las tarjetas de productos dinámicamente -->
                                    </div>
                                    <!-- Row end -->

                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Row end -->

                </div>
                <!-- Content wrapper end -->

            </div>
            <!-- Content wrapper scroll end -->

        </div>
        <!-- Main container end -->

    </div>
    <!-- Page wrapper end -->

    <!-- JavaScript Files -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/modernizr.js"></script>
    <script src="assets/js/moment.js"></script>
    <script src="assets/vendor/overlay-scroll/jquery.overlayScrollbars.min.js"></script>
    <script src="assets/vendor/overlay-scroll/custom-scrollbar.js"></script>
    <script src="assets/js/main.js"></script>

    <!-- Dynamic Product List Script -->
    <script>
        const endpoint = "https://getallproducts-dztx2pd2na-uc.a.run.app/";

        // Función para crear la tarjeta de producto
        function createProductCard(product) {
            return `
                <div class="col-xxl-3 col-md-4 col-sm-6 col-12" id="product-${product.id}">
                    <div class="product-card">
                        <img class="product-card-img-top" src="${product.imagen}" alt="${product.nombre}">
                        <div class="product-card-body">
                            <h5 class="product-title">${product.nombre}</h5>
                            <div class="product-price">
                                <span class="disount-price">$${product.precio_rebajado}</span>
                                <span class="actucal-price">$${product.precio_normal}</span>
                                <span class="off-price">${((product.precio_normal - product.precio_rebajado) / product.precio_normal * 100).toFixed(2)}% Off</span>
                            </div>
                            <div class="product-description">
                                <span class="product-id">ID: ${product.id}</span><br>
                                <span class="id-category">Categoría: ${product.id_categoria}</span><br>
                                <span class="product-quantity">Stock: ${product.cantidad}</span>
                                <p>${product.descripcion}</p>
                            </div>

                            <!-- Asignamos el ID del producto al atributo data-id del botón -->
                            <button type="button" class="btn btn-danger delete-button" data-id="${product.id}">
                                <span class="icon">
                                    <i class="bi bi-trash"></i>
                                </span>
                            </button>

                        </div>
                    </div>
                </div>
            `;
        }

        // Función para eliminar un producto usando DELETE y enviando el ID como un int en el cuerpo
        // Función para eliminar un producto usando DELETE y enviando el ID como un int en el cuerpo
        async function deleteProduct(productId) {
            if (!productId) {
                console.error("El ID del producto es nulo o indefinido.");
                return;
            }

            try {
                const response = await fetch("https://deleteproduct-dztx2pd2na-uc.a.run.app", {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: parseInt(productId, 10) }), // Enviamos el ID como un entero
                });

                if (response.ok) {
                    // Eliminar el producto de la interfaz
                    document.getElementById(`product-${productId}`).remove();
                    alert("Producto eliminado correctamente");
                } else {
                    const errorData = await response.json();
                    console.error("Error al eliminar el producto:", errorData);
                }
            } catch (error) {
                console.error("Error en la petición de eliminación:", error);
            }
        }

        // Función para cargar los productos desde el endpoint
        async function loadProducts() {
            try {
                const response = await fetch(endpoint);
                const products = await response.json();

                const productList = document.getElementById('product-list');

                products.forEach(product => {
                    const productCardHTML = createProductCard(product);
                    productList.innerHTML += productCardHTML; // Insertamos las tarjetas en el HTML
                });

                // Agregar el event listener a los botones de eliminar después de cargar los productos
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', function () {
                        const productId = this.getAttribute('data-id'); // Obtener el atributo 'data-id'
                        console.log("ID del producto a eliminar:", productId); // Verificar el ID en la consola
                        deleteProduct(productId); // Llamamos a la función de eliminar producto
                    });
                });

            } catch (error) {
                console.error("Error al cargar los productos:", error);
            }
        }

        // Llamamos a la función para cargar los productos cuando se cargue la página
        window.onload = loadProducts;



    </script>
</body>

</html>
