<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Meta -->
    <meta name="description" content="Responsive Bootstrap Admin Dashboards">
    <meta name="author" content="Bootstrap Gallery" />
    <link rel="canonical" href="https://www.bootstrap.gallery/">
    <meta property="og:url" content="https://www.bootstrap.gallery">
    <meta property="og:title" content="Admin Templates - Dashboard Templates | Bootstrap Gallery">
    <meta property="og:description" content="Marketplace for Bootstrap Admin Dashboards">
    <meta property="og:type" content="Website">
    <meta property="og:site_name" content="Bootstrap Gallery">
    <link rel="shortcut icon" href="assets/images/logo_zazil.png">
<!-- Bootstrap CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">



    <!-- Title -->
    <title>Zazil Productos</title>

    <!-- Common Css Files -->
    <link rel="stylesheet" href="assets/css/animate.css">
    <link rel="stylesheet" href="assets/fonts/bootstrap/bootstrap-icons.css">
    <link rel="stylesheet" href="assets/css/main.min.css">

    <!-- Vendor Css Files -->
    <link rel="stylesheet" href="assets/vendor/overlay-scroll/OverlayScrollbars.min.css">
</head>

<body>

    <!-- Page wrapper start -->
    <div class="page-wrapper">

        <!-- Sidebar wrapper start -->
        <nav class="sidebar-wrapper">
            <!-- Sidebar brand starts -->
            <div class="sidebar-brand">
                <a href="index.html" class="logo">
                    <img src="assets/images/logo_zazil.png"/>
                </a>
            </div>
            <!-- Sidebar brand starts -->

            <!-- Sidebar menu starts -->
            <div class="sidebar-menu">
                <div class="sidebarMenuScroll">
                    <ul>
                        <li class="sidebar-dropdown">
                            <a href="index.html">
                                <i class="bi bi-house"></i>
                                <span class="menu-text">Dashboard</span>
                            </a>
                        </li>
                        <li class="sidebar-dropdown active">
                            <a href="#">
                                <i class="bi bi-handbag"></i>
                                <span class="menu-text">Ventas</span>
                            </a>
                            <div class="sidebar-submenu">
                                <ul>
                                    <li>
                                        <a href="orders.html">Historial Compras</a>
                                    </li>
                                    <li>
                                        <a href="products.html" class="current-page">Productos</a>
                                    </li>
                                    <li>
                                        <a href="add-product.html">Añadir Productos</a>
                                    </li>
                                    <li>
                                        <a href="add-post.html">Añadir Publicación</a>
                                    </li>
                                    <li>
                                        <a href="add-faq.html">Añadir Pregunta <br> <center>Frecuente</center></a>
                                    </li>
                                </ul>
                            </div>
                        </li>
                        <li class="sidebar">
                            <a href="calendar-google.html">
                                <i class="bi bi-calendar4"></i>
                                <span class="menu-text">Calendarios</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- Sidebar menu ends -->
        </nav>
        <!-- Sidebar wrapper end -->

        <!-- Main container start -->
        <div class="main-container">
            

            <!-- Page header starts -->
            <div class="page-header">
                <div class="toggle-sidebar" id="toggle-sidebar"><i class="bi bi-list"></i></div>

                <!-- Breadcrumb start -->
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><i class="bi bi-house"></i></li>
                    <li class="breadcrumb-item breadcrumb-active" aria-current="page">Productos</li>
                </ol>
                <!-- Breadcrumb end -->

                <!-- Header actions start -->
          <ul class="header-actions">
            <li class="dropdown">
              <a href="#" id="userSettings" class="user-settings" data-toggle="dropdown" aria-haspopup="true">
                <span class="user-name d-none d-md-block">Administrador</span>
                <span class="avatar">
                  <img src="https://definicion.de/wp-content/uploads/2019/07/perfil-de-usuario.png" alt="Free Admin Templates">
                  
                </span>
              </a>
              <div class="dropdown-menu dropdown-menu-end" aria-labelledby="userSettings">
                <div class="header-profile-actions">
                  <a href="#" id="logout">Cerrar sesión</a>
                </div>
              </div>
            </li>
          </ul>
          <!-- Header actions end -->
            </div>
            <!-- Page header ends -->

            <!-- Content wrapper scroll start -->
            <div class="content-wrapper-scroll">

                <!-- Content wrapper start -->
                <div class="content-wrapper">

                    <!-- Row start -->
                    <div class="row gx-3">
                        <div class="col-sm-12 col-12">
                            <div class="card">
                                <div class="card-header">
                                    <div class="card-title">Lista de productos</div>
                                </div>
                                <div class="card-body">

                                    <!-- Row start -->
                                    <div class="row gx-3" id="product-list">
                                        <!-- Aquí se insertarán las tarjetas de productos dinámicamente -->
                                    </div>
                                    <!-- Row end -->

                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Row end -->

                </div>
                <!-- Content wrapper end -->

            </div>
            <!-- Content wrapper scroll end -->

        </div>
        <!-- Main container end -->
           <!-- Modal para editar el precio -->
    <div id="editPriceModal" style="display: none;">
        <div class="modal-content">
            <h3>Editar Precio</h3>
            <label for="precioNormal">Precio Normal:</label>
            <input type="number" id="precioNormal" step="0.01"><br>
            <label for="precioRebajado">Precio Rebajado:</label>
            <input type="number" id="precioRebajado" step="0.01"><br>
            <button id="savePriceButton">Guardar</button>
            <button id="closeModalButton">Cerrar</button>
        </div>
    </div>

    </div>
    <!-- Page wrapper end -->

    <!-- JavaScript Files -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/modernizr.js"></script>
    <script src="assets/js/moment.js"></script>
    <script src="assets/vendor/overlay-scroll/jquery.overlayScrollbars.min.js"></script>
    <script src="assets/vendor/overlay-scroll/custom-scrollbar.js"></script>
    <script src="assets/js/main.js"></script>

    <!-- Dynamic Product List Script -->
    <script>
        const endpoint = "https://getallproducts-dztx2pd2na-uc.a.run.app/";
    
        // Función para crear la tarjeta de producto
        function createProductCard(product) {
            return `
                <div class="col-xxl-3 col-md-4 col-sm-6 col-12" id="product-${product.id}">
                    <div class="product-card">
                        <img class="product-card-img-top" src="${product.imagen}" alt="${product.nombre}">
                        <div class="product-card-body">
                            <h5 class="product-title">${product.nombre}</h5>
                            <div class="product-price">
                                <span class="discount-price">$${product.precio_rebajado}  </span>
                                <span class="actual-price">$${product.precio_normal}</span>
                                <span class="off-price">-${((product.precio_normal - product.precio_rebajado) / product.precio_normal * 100).toFixed(2)}%</span>
                            </div>

                           

                            <div class="product-description">
                                <span class="product-id">ID: ${product.id}</span><br>
                                <span class="id-category">Categoría: ${product.id_categoria}</span><br>
                                <span class="product-quantity">Stock: ${product.cantidad}</span>
                                <p>${product.descripcion}</p>
                            </div>
    
                            <!-- Botón para eliminar producto -->
                            <button type="button" class="btn btn-danger delete-button" data-id="${product.id}">
                                <span class="icon">
                                    <i class="bi bi-trash"></i>
                                </span>
                            </button>
    
                            <!-- Botón para editar precio -->
                            <button style="width: 70%; text-align: right; padding:0px" type="button" class="btn edit-price-button" data-id="${product.id}">
                                <span class="icon">
                                    <div>
                                        <i class="bi bi-pencil"></i>
                                    </div>
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
    
        // Función para eliminar un producto usando DELETE y enviando el ID como un int en el cuerpo
        async function deleteProduct(productId) {
            if (!productId) {
                console.error("El ID del producto es nulo o indefinido.");
                return;
            }
    
            try {
                const response = await fetch("https://deleteproduct-dztx2pd2na-uc.a.run.app", {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id: parseInt(productId, 10) }), // Enviamos el ID como un entero
                });
    
                if (response.ok) {
                    // Eliminar el producto de la interfaz
                    document.getElementById(`product-${productId}`).remove();
                    alert("Producto eliminado correctamente");
                } else {
                    const errorData = await response.json();
                    console.error("Error al eliminar el producto:", errorData);
                }
            } catch (error) {
                console.error("Error en la petición de eliminación:", error);
            }
        }
    
        // Función para cargar los productos desde el endpoint
        async function loadProducts() {
            try {
                const response = await fetch(endpoint);
                const products = await response.json();
    
                const productList = document.getElementById('product-list');
    
                products.forEach(product => {
                    const productCardHTML = createProductCard(product);
                    productList.insertAdjacentHTML('beforeend', productCardHTML); // Insertamos las tarjetas en el HTML
                });
    
                // Agregar el event listener a los botones de eliminar después de cargar los productos
                document.querySelectorAll('.delete-button').forEach(button => {
                    button.addEventListener('click', function () {
                        const productId = this.getAttribute('data-id'); // Obtener el atributo 'data-id'
                        deleteProduct(productId); // Llamamos a la función de eliminar producto
                    });
                });
    
                // Agregar event listener a los botones de editar precio después de cargar los productos
                document.querySelectorAll('.edit-price-button').forEach(button => {
                    button.addEventListener('click', function () {
                        const productId = this.getAttribute('data-id'); // Obtener el atributo 'data-id'
                        showEditPriceModal(productId); // Llamamos a la función para mostrar el modal de editar precio
                    });
                });
    
            } catch (error) {
                console.error("Error al cargar los productos:", error);
            }
        }
    
        // Función para mostrar el modal de edición de precio
        function showEditPriceModal(productId) {
            // Eliminar el modal anterior si ya existe en el DOM
            const existingModal = document.getElementById('editPriceModal');
            if (existingModal) {
                existingModal.remove();
            }
    
            const modalHtml = `
                <div class="custom-modal" id="editPriceModal">
                    <div class="modal-content">
                        <h5 class="modal-title">Editar Precio y Stock</h5>
                        <p>Ingrese únicamente el/los campos a modificar</p>
                        <form id="edit-price-form">
                            <div class="mb-3">
                                <label for="normalPrice" class="form-label">Precio Normal</label>
                                <input type="number" class="form-control" id="normalPrice" step="0.01">
                            </div>
                            <div class="mb-3">
                                <label for="discountPrice" class="form-label">Precio Rebajado</label>
                                <input type="number" class="form-control" id="discountPrice" step="0.01">
                            </div>
                            <div class="mb-3">
                                <label for="stock" class="form-label">Stock</label>
                                <input type="number" class="form-control" id="stock" step="1">
                            </div>
                        </form>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeEditPriceModal()">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="updateProductPrice(${productId})">Guardar Cambios</button>
                        </div>
                    </div>
                </div>
            `;
    
            // Agregar el modal al body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
    
            // Función para cerrar el modal
            window.closeEditPriceModal = function () {
                const modalElement = document.getElementById('editPriceModal');
                if (modalElement) {
                    modalElement.remove();
                }
            };
        }
    
        // Función para mostrar el mensaje de confirmación
        function showConfirmationMessage() {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = 'Datos actualizados correctamente';
            document.body.appendChild(notification);
    
            // Mostrar el mensaje de confirmación
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);
    
            // Ocultar el mensaje de confirmación después de 3 segundos
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300); // Espera a que la transición de opacidad termine antes de eliminar el elemento
            }, 3000);
        }
    
        // Función para mostrar un mensaje de error al usuario
        function showErrorMessage(message) {
            alert(message); // Puedes cambiar esto a cualquier otra lógica de notificación que uses
        }
    
        // Función para actualizar el precio del producto
        async function updateProductPrice(productId) {
            const normalPrice = document.getElementById('normalPrice').value;
            const discountPrice = document.getElementById('discountPrice').value;
            const stock = document.getElementById('stock').value;
    
            // Variable para almacenar el cuerpo del JSON
            let requestBody = {};
    
            try {
                // Validar los campos de precio y stock
                if (!normalPrice && !discountPrice && stock) {
                    // Solo stock tiene valor, crear JSON con stock
                    requestBody = {
                        id: productId,
                        cantidad: parseInt(stock)
                    };
                } else if (normalPrice && discountPrice && stock) {
                    // Todos los valores son válidos
                    requestBody = {
                        id: productId,
                        precio_normal: parseFloat(normalPrice),
                        precio_rebajado: parseFloat(discountPrice),
                        cantidad: parseInt(stock)
                    };
                } else if (normalPrice && !discountPrice || !normalPrice && discountPrice) {
                    // Uno de los precios es null y el otro tiene valor, mostrar error
                    showErrorMessage("Debe ingresar ambos precios, normal y rebajado.");
                    return; // Detener la ejecución si hay un error
                } else if (normalPrice && discountPrice && !stock) {
                    // Solo precios tienen valor, crear JSON sin stock
                    requestBody = {
                        id: productId,
                        precio_normal: parseFloat(normalPrice),
                        precio_rebajado: parseFloat(discountPrice)
                    };
                } else {
                    // Si todos los valores son null o no válidos
                    showErrorMessage("Debe ingresar al menos el precio o la cantidad.");
                    return; // Detener la ejecución si no hay datos válidos
                }
    
                // Realizar la petición
                const response = await fetch("https://updateproductprice-dztx2pd2na-uc.a.run.app/", {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                });
    
                // Imprimir JSON en la consola
                console.log(JSON.stringify(requestBody));
    
                if (response.ok) {
                    // Actualizar el precio en la interfaz
                    const productCard = document.getElementById(`product-${productId}`);
                    const discountPriceElement = productCard.querySelector('.discount-price');
                    const actualPriceElement = productCard.querySelector('.actual-price');
                    const offPriceElement = productCard.querySelector('.off-price');
                    const stockElement = productCard.querySelector('.product-quantity'); // Corregido
    
                    if (discountPriceElement && discountPrice) {
                        discountPriceElement.textContent = `$${parseFloat(discountPrice).toFixed(2)}`;
                    }
    
                    if (actualPriceElement && normalPrice) {
                        actualPriceElement.textContent = `$${parseFloat(normalPrice).toFixed(2)}`;
                    }
    
                    if (offPriceElement && normalPrice && discountPrice) {
                        const discountPercentage = ((parseFloat(normalPrice) - parseFloat(discountPrice)) / parseFloat(normalPrice) * 100).toFixed(2);
                        offPriceElement.textContent = `${discountPercentage}% Off`;
                    }
    
                    if (stockElement && stock) {
                        stockElement.textContent = `Stock: ${parseInt(stock)}`;
                    }
    
                    // Mostrar el mensaje de confirmación
                    showConfirmationMessage();
    
                    // Cerrar el modal
                    closeEditPriceModal();
                } else {
                    const errorData = await response.json();
                    console.error("Error al actualizar el precio del producto:", errorData);
                }
            } catch (error) {
                console.error("Error en la petición de actualización de precio:", error);
            }
        }
    
        // Llamamos a la función para cargar los productos cuando se cargue la página
        window.onload = loadProducts;
    </script>
    
<!-- Bootstrap JS (al final del body para cargar después del HTML) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

<!-- Firebase SDK -->
<script type="module">
    // Firebase SDK imports
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js';
    import { getAuth, signOut } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-auth.js';
    import { getFirestore } from 'https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyA3wgArHQ2TbPMzgKskD-HSMxN1WQfzm_s",
      authDomain: "zazil-app.firebaseapp.com",
      projectId: "zazil-app",
      storageBucket: "zazil-app.appspot.com",
      messagingSenderId: "3024441242",
      appId: "1:3024441242:web:45eea9b414efaa37383423"
    };

    // Firebase initialization
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Verificar si el usuario ha iniciado sesión
    auth.onAuthStateChanged((user) => {
      if (user) {
        // Usuario está autenticado
        console.log('User is authenticated:', user.email);
      } else {
        // Usuario no está autenticado, redirigir al login
        window.location.href = 'login.html'; // Cambia 'login.html' por la ruta correcta a tu página de inicio de sesión
      }
    });

    // Agregar event listener para el botón de logout
    document.getElementById('logout').addEventListener('click', (e) => {
      e.preventDefault(); // Evitar el comportamiento por defecto del enlace

      signOut(auth).then(() => {
        // Cierre de sesión exitoso, redirigir al login
        window.location.href = 'login.html';
      }).catch((error) => {
        // Manejar errores
        console.error('Error signing out:', error);
      });
    });

    // Aquí puedes agregar tu lógica adicional para usuarios autenticados
  </script>


<style>
    /* Estilos para el modal */
    #editPriceModal {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 20px;
        box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        border-radius: 1rem;
    }
    .modal-content {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .custom-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border: 1px solid #ddd;
    padding: 20px;
    z-index: 1050; /* Asegura que esté por encima del contenido */
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    width: 300px; /* Ajusta el tamaño según sea necesario */
}

.modal-content {
    display: flex;
    flex-direction: column;
}

.modal-footer {
    display: flex;
    justify-content: space-between;
    padding-top: 15px;
}
.notification {
    position: fixed;
    bottom: 10px;
    right: 10px;
    background-color: #28a745;
    color: white;
    padding: 10px;
    border-radius: 5px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    opacity: 0;
    transition: opacity 0.3s ease-in-out;
    z-index: 9999;
}

.notification.show {
    opacity: 1;
}


</style>

</body>

</html>
